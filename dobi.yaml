# ===================================================
# images
# ===================================================

image=image-kas:
  image: ghcr.io/siemens/kas/kas
  tags: ["2.6.3"]
  pull: once

image=image-curl-jq:
  image: dwdraju/alpine-curl-jq
  tags: [latest]
  pull: once

image=image-mender-cli:
  image: ci4rail/mender-cli
  tags: [master]
  pull: once

image=image-minio-client:
  image: minio/mc
  tags: [latest]
  pull: once

image=image-ssh-client:
  image: kroniak/ssh-client
  tags: [latest]
  pull: once

# ===================================================
# mounts
# ===================================================

# Where the yocto-build happens
mount=build-dir-yocto:
  bind: yocto
  path: /work

# Yocto downloads DL_DIR
mount=download-dir-yocto:
  bind: "{env.YOCTO_DOWNLOAD_DIR:cache/downloads}"
  path: /downloads

# Yocto shared state cache SSTATE_DIR
mount=sstate-dir-yocto:
  bind: "{env.YOCTO_SSTATE_CACHE_DIR:cache/sstate-cache}"
  path: /sstate-cache

# Yocto images (DEPLOY_DIR)
mount=install-dir-yocto:
  bind: yocto/install
  path: /install

# Scripts
mount=scripts-dir:
  bind: scripts
  path: /scripts

mount=mender-auth-dir:
  bind: "{env.MENDER_AUTH_DIR:~/.cache/mender}"
  path: /mender-auth

# The location of kas-include files
mount=kas-includes-dir:
  bind: kas-includes
  path: /kas-includes
  read-only: true

mount=ssh-dir:
  bind: "{user.home}/.ssh/"
  path: "/root/.ssh/"
  read-only: true

# ===================================================
# envs
# ===================================================

env=yocto-envs:
  files:
    - config/secret.env
    - config/custom.env

# ===================================================
# jobs
# ===================================================
job=mender-accept-latest-auth:
  use: image-curl-jq
  mounts:
    - scripts-dir
    - mender-auth-dir
  user: "{user.uid}:{user.gid}"
  depends:
    - yocto-envs
  env:
    - MENDER_DEVICE_ID={env.MENDER_DEVICE_ID}
    - MENDER_AUTH_TOKEN=/mender-auth/authtoken
    - MENDER_SERVER_URL={env.MENDER_SERVER_URL}
  command: /scripts/mender_accept_new_auth_set.sh
  annotations:
    description: "\t\t\t\t--> Accept latest auth set for device with MENDER_DEVICE_ID"

alias=all-build:
  tasks:
    - cpu01-devtools-build-image
    - cpu01-edgefarm-build-image
    - cpu01-edgefarm-devtools-build-image
    - cpu01plus-devtools-build-image
    - cpu01plus-edgefarm-build-image
    - cpu01plus-edgefarm-devtools-build-image
    - raspberrypi4-64-edgefarm-build-image
    - raspberrypi4-64-edgefarm-devtools-build-image
  annotations:
    tags:
      - alias
    description: "\t\t\t\t\t--> [alias] build all images"

alias=all-minio-push:
  tasks:
    - cpu01-devtools-minio-push
    - cpu01-edgefarm-minio-push
    - cpu01-edgefarm-devtools-minio-push
    - cpu01plus-devtools-minio-push
    - cpu01plus-edgefarm-minio-push
    - cpu01plus-edgefarm-devtools-minio-push
    - raspberrypi4-64-edgefarm-minio-push
    - raspberrypi4-64-edgefarm-devtools-minio-push
  annotations:
    tags:
      - alias
    description: "\t\t\t\t\t--> [alias] push all images to Minio"

alias=all-mender-upload:
  tasks:
    - cpu01-devtools-mender-upload
    - cpu01-edgefarm-mender-upload
    - cpu01-edgefarm-devtools-mender-upload
    - cpu01plus-devtools-mender-upload
    - cpu01plus-edgefarm-mender-upload
    - cpu01plus-edgefarm-devtools-mender-upload
    - raspberrypi4-64-edgefarm-mender-upload
    - raspberrypi4-64-edgefarm-devtools-mender-upload
  annotations:
    tags:
      - alias
    description: "\t\t\t\t\t--> [alias] upload all images to mender"

#
# MINIO Shortcut
# 

# CPU01
alias=cpu01-devtools-minio:
  tasks:
    - cpu01-devtools-build-image
    - cpu01-devtools-minio-push
    - cpu01-devtools-minio-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t\t\t--> [alias] build cpu01 devtools image and install via Minio"

alias=cpu01-edgefarm-minio:
  tasks:
    - cpu01-edgefarm-build-image
    - cpu01-edgefarm-minio-push
    - cpu01-edgefarm-minio-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t\t\t--> [alias] build cpu01 edgefarm image and install via Minio"

alias=cpu01-edgefarm-devtools-minio:
  tasks:
    - cpu01-edgefarm-devtools-build-image
    - cpu01-edgefarm-devtools-minio-push
    - cpu01-edgefarm-devtools-minio-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t--> [alias] build cpu01 edgefarm devtools image and install via Minio"

# CPU01PLUS
alias=cpu01plus-devtools-minio:
  tasks:
    - cpu01plus-devtools-build-image
    - cpu01plus-devtools-minio-push
    - cpu01plus-devtools-minio-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t\t\t--> [alias] build cpu01plus devtools image and install via Minio"

alias=cpu01plus-edgefarm-minio:
  tasks:
    - cpu01plus-edgefarm-build-image
    - cpu01plus-edgefarm-minio-push
    - cpu01plus-edgefarm-minio-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t\t\t--> [alias] build cpu01plus edgefarm image and install via Minio"

alias=cpu01plus-edgefarm-devtools-minio:
  tasks:
    - cpu01plus-edgefarm-devtools-build-image
    - cpu01plus-edgefarm-devtools-minio-push
    - cpu01plus-edgefarm-devtools-minio-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t--> [alias] build cpu01plus edgefarm devtools image and install via Minio"


#
# MENDER Shortcut
# 

# CPU01
alias=cpu01-devtools-mender:
  tasks:
    - cpu01-devtools-build-image
    - cpu01-devtools-mender-upload
    - cpu01-devtools-mender-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t\t--> [alias] build cpu01 devtools image and install via Mender"

alias=cpu01-edgefarm-mender:
  tasks:
    - cpu01-edgefarm-build-image
    - cpu01-edgefarm-mender-upload
    - cpu01-edgefarm-mender-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t\t--> [alias] build cpu01 edgefarm image and install via Mender"

alias=cpu01-edgefarm-devtools-mender:
  tasks:
    - cpu01-edgefarm-devtools-build-image
    - cpu01-edgefarm-devtools-mender-upload
    - cpu01-edgefarm-devtools-mender-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t--> [alias] build cpu01 edgefarm devtools image and install via Mender"

# CPU01PLUS
alias=cpu01plus-devtools-mender:
  tasks:
    - cpu01plus-devtools-build-image
    - cpu01plus-devtools-mender-upload
    - cpu01plus-devtools-mender-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t\t--> [alias] build cpu01plus devtools image and install via Mender"

alias=cpu01plus-edgefarm-mender:
  tasks:
    - cpu01plus-edgefarm-build-image
    - cpu01plus-edgefarm-mender-upload
    - cpu01plus-edgefarm-mender-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t\t--> [alias] build cpu01plus edgefarm image and install via Mender"

alias=cpu01plus-edgefarm-devtools-mender:
  tasks:
    - cpu01plus-edgefarm-devtools-build-image
    - cpu01plus-edgefarm-devtools-mender-upload
    - cpu01plus-edgefarm-devtools-mender-deploy
  annotations:
    tags:
      - alias
    description: "\t\t\t--> [alias] build cpu01plus edgefarm devtools image and install via Mender"
