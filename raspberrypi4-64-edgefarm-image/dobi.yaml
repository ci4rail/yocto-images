# ===================================================
# mounts
# ===================================================
# Yocto images (DEPLOY_DIR)
mount=install-dir-raspberrypi4-64-edgefarm:
  bind: raspberrypi4-64-edgefarm-image/install
  path: /install

# Where the yocto-build happens
mount=build-dir-raspberrypi4-64-edgefarm:
  bind: raspberrypi4-64-edgefarm-image
  path: /work

# ===================================================
# jobs
# ===================================================
# Get layer revisions
job=raspberrypi4-64-edgefarm-yocto-layer-revparse:
  use: image-kas
  entrypoint: /bin/bash
  command: /git/scripts/layer-revparse.sh /git/raspberrypi4-64-edgefarm-image/src /git/raspberrypi4-64-edgefarm-image/layer-revs
  mounts:
    - mount-buildingblock-gitversion-source-dir
  sources: raspberrypi4-64-edgefarm-image/src
  artifact: raspberrypi4-64-edgefarm-image/layer-revs
  user: "{user.uid}:{user.gid}"

job=raspberrypi4-64-edgefarm-print-image-version:
  use: image-kas
  depends:
    - raspberrypi4-64-edgefarm-yocto-layer-revparse
  mounts:
    - mount-buildingblock-gitversion-source-dir
  user: "{user.uid}:{user.gid}"
  env:
    - "USER={user.name}"
  entrypoint: /bin/bash
  command: /git/scripts/gen-image-version.sh
    /git
    /git/raspberrypi4-64-edgefarm-image/layer-revs

job=raspberrypi4-64-edgefarm-yocto-shell:
  use: image-kas
  depends:
    - yocto-envs
    - raspberrypi4-64-edgefarm-print-image-version:capture(IMAGE_GIT_VERSION)
  mounts:
    - build-dir-raspberrypi4-64-edgefarm
    - kas-includes-dir
    - download-dir-yocto
    - sstate-dir-yocto
    - install-dir-raspberrypi4-64-edgefarm
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash
    - MENDER_SERVER_URL={env.MENDER_SERVER_URL}
    - MENDER_TENANT_TOKEN={env.MENDER_TENANT_TOKEN}
    - IMAGE_NAME_SUFFIX={env.NAME_SUFFIX}
    - IMAGE_GIT_VERSION={env.IMAGE_GIT_VERSION}
    - MENDER_ARTIFACT_NAME=raspberrypi4-64-edgefarm-{env.IMAGE_GIT_VERSION}{env.NAME_SUFFIX}
  command: shell kasfile.yaml
  annotations:
    description: "\t\t\t--> interactive yocto shell raspberrypi4-64-edgefarm config"
    tags:
      - edgefarm

job=raspberrypi4-64-edgefarm-build-image:
  use: image-kas
  mounts:
    - build-dir-raspberrypi4-64-edgefarm
    - kas-includes-dir
    - download-dir-yocto
    - sstate-dir-yocto
    - install-dir-raspberrypi4-64-edgefarm
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash
    - MENDER_SERVER_URL={env.MENDER_SERVER_URL}
    - MENDER_TENANT_TOKEN={env.MENDER_TENANT_TOKEN}
    - IMAGE_NAME_SUFFIX={env.NAME_SUFFIX}
    - IMAGE_GIT_VERSION={env.IMAGE_GIT_VERSION}
    - MENDER_ARTIFACT_NAME=raspberrypi4-64-edgefarm-{env.IMAGE_GIT_VERSION}{env.NAME_SUFFIX}
  depends:
    - yocto-envs
    - raspberrypi4-64-edgefarm-print-image-version:capture(IMAGE_GIT_VERSION)
  command: build kasfile.yaml
  annotations:
    description: "\t\t\t--> Build raspberrypi4-64-edgefarm-image"
    tags:
      - edgefarm

job=raspberrypi4-64-edgefarm-mender-upload:
  use: image-mender-cli
  interactive: true
  mounts:
    - install-dir-raspberrypi4-64-edgefarm
    - mender-auth-dir
  user: "{user.uid}:{user.gid}"
  entrypoint: /bin/sh
  command: -c "/mender-cli --token=/mender-auth/authtoken artifacts upload /install/images/raspberrypi4-64/raspberrypi4-64_EdgeFarm-Devtools-Image*.mender"
  annotations:
    description: "\t\t--> Upload raspberrypi4-64-edgefarm image to mender"
    tags:
      - edgefarm

job=raspberrypi4-64-edgefarm-mender-deploy:
  use: image-curl-jq
  mounts:
    - install-dir-raspberrypi4-64-edgefarm
    - scripts-dir
    - mender-auth-dir
  user: "{user.uid}:{user.gid}"
  depends:
    - yocto-envs
    - mender-accept-latest-auth
  env:
    - MENDER_DEVICE_ID={env.RPI_MENDER_DEVICE_ID}
    - MENDER_AUTH_TOKEN=/mender-auth/authtoken
    - MENDER_SERVER_URL={env.MENDER_SERVER_URL}
  command: /scripts/mender_deploy_artifact_to_device.sh /install/images/raspberrypi4-64/raspberrypi4-64_EdgeFarm-Devtools-Image*.mender
  annotations:
    description: "\t\t--> Deploy raspberrypi4-64-edgefarm image to RPI_MENDER_DEVICE_ID"
    tags:
      - edgefarm

job=raspberrypi4-64-edgefarm-minio-push:
  use: image-minio-client
  mounts:
    - build-dir-raspberrypi4-64-edgefarm
  entrypoint: /bin/sh
  depends:
    - yocto-envs
  command: |
    -c "
        fileToPush=$(ls -t /work/install/images/raspberrypi4-64/ls -t /work/install/images/raspberrypi4-64/raspberrypi4-64_EdgeFarm-Image*sdimg*sdimg)
        echo Push image ${fileToPush} to minio
        mc cp ${fileToPush} ci4rail_endpoint/${BUCKET}/
       "
  env:
    - MC_HOST_ci4rail_endpoint=https://{env.MINIO_ACCESS_KEY}:{env.MINIO_SECRET_KEY}@{env.MINIO_ENDPOINT}
    - BUCKET=raspberrypi4-64-edgefarm-dev
  annotations:
    description: "\t\t\t--> Push raspberrypi4-64-edgefarm image to Minio"
    tags:
      - edgefarm
