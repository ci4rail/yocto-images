# ===================================================
# mounts
# ===================================================
# Yocto images (DEPLOY_DIR)
mount=install-dir-base:
  bind: base-image/install
  path: /install

# Where the yocto-build happens
mount=build-dir-base:
  bind: base-image
  path: /work

# ===================================================
# jobs
# ===================================================
# Get layer revisions
job=base-yocto-layer-revparse:
  use: image-kas
  entrypoint: /bin/bash
  command: /git/scripts/layer-revparse.sh /git/base-image/src /git/base-image/layer-revs
  mounts:
    - mount-buildingblock-gitversion-source-dir
  sources: base-image/src
  artifact: base-image/layer-revs
  user: "{user.uid}:{user.gid}"

job=base-print-image-version:
  use: image-kas
  depends:
    - base-yocto-layer-revparse
  mounts:
    - mount-buildingblock-gitversion-source-dir
  user: "{user.uid}:{user.gid}"
  env:
    - "USER={user.name}"
  entrypoint: /bin/bash
  command: /git/scripts/gen-image-version.sh
    /git
    /git/base-image/layer-revs

job=cpu01-base-yocto-shell:
  use: image-kas
  depends:
    - yocto-envs
    - base-print-image-version:capture(IMAGE_GIT_VERSION)
  mounts:
    - build-dir-base
    - kas-includes-dir
    - download-dir-yocto
    - sstate-dir-yocto
    - install-dir-base
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash
    - IMAGE_NAME_SUFFIX={env.NAME_SUFFIX}
    - IMAGE_GIT_VERSION={env.IMAGE_GIT_VERSION}
  command: "shell kasfile-cpu01-base.yaml"
  annotations:
    description: "\t\t--> interactive yocto shell cpu01-base config"
    tags:
      - base

job=cpu01-base-build-image:
  use: image-kas
  mounts:
    - build-dir-base
    - kas-includes-dir
    - download-dir-yocto
    - sstate-dir-yocto
    - install-dir-base
  working-dir: /work
  interactive: true
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - TERM=xterm-256color
    - SHELL=/bin/bash
    - IMAGE_NAME_SUFFIX={env.NAME_SUFFIX}
    - IMAGE_GIT_VERSION={env.IMAGE_GIT_VERSION}
  depends:
    - yocto-envs
    - base-print-image-version:capture(IMAGE_GIT_VERSION)
  command: build kasfile-cpu01-base.yaml
  annotations:
    description: "\t\t--> Build cpu01-base-image"
    tags:
      - base

job=cpu01-base-minio-push:
  use: image-minio-client
  mounts:
    - build-dir-base
  entrypoint: /bin/sh
  depends:
    - yocto-envs
  command: |
    -c "
        fileToPush=$(ls -t /work/install/images/moducop-cpu01/*Base-Image*ci4rail_tezi.tar | head -n 1)
        echo Push image ${fileToPush} to minio
        mc cp ${fileToPush} ci4rail_endpoint/${BUCKET}/
       "
  env:
    - MC_HOST_ci4rail_endpoint=https://{env.MINIO_ACCESS_KEY}:{env.MINIO_SECRET_KEY}@{env.MINIO_ENDPOINT}
    - BUCKET=cpu01-base-dev
  annotations:
    description: "\t\t--> Push cpu01-base image to Minio"
    tags:
      - base

job=cpu01-base-minio-deploy:
  use: image-ssh-client
  mounts:
    - build-dir-base
    - ssh-dir
  interactive: true
  net-mode: host
  entrypoint: /bin/bash
  depends:
    - yocto-envs
  command: |
    -c '
      fileToInstall=$(ls -t /work/install/images/moducop-cpu01/*Base-Image*ci4rail_tezi.tar | head -n 1 | rev | cut -d"/" -f 1 | rev)
      echo Deploy image ${fileToInstall} using Raspberry Pi with IP ${RASPBERRY_PI_IP} to connected Moducop
      ssh yoda@${RASPBERRY_PI_IP} "
          s3cmd --config=/etc/s3cfg_ci4rail_minio get s3://${BUCKET}/${fileToInstall} /tmp/tezi-image.tar --force
          sudo make-gadget-image /tmp/tezi-image.tar /tmp/tezi.img
          docker run \
                  --network=host \
                  --rm \
                  --privileged \
                  --name=tdx-installer \
                  -e BRICKD_UID=\$BRICKD_UID \
                  -e BRICKD_PORT=\$BRICKD_PORT \
                  -e BRICKD_IP=\$BRICKD_IP \
                  -v /tmp/tezi.img:/mnt/yocto_image/yocto.img \
                  -v /dev/${CONSOLE_PORT}:/dev/ttyTEZI \
                  -v /sys:/sys \
                  -v /dev:/dev \
                  ci4rail/tdx-installer:${TDX_INSTALLER_IMAGE_TAG} \
                  --timeout 600
          tinkerforge call industrial-dual-relay-bricklet \$BRICKD_UID set-monoflop 0 false 2000
          rm /tmp/tezi-image.tar
          sudo rm /tmp/tezi.img
        "
       '
  env:
    - USER_ID={user.uid}
    - GROUP_ID={user.gid}
    - RASPBERRY_PI_IP={env.RASPBERRY_PI_IP}
    - BUCKET=cpu01-base-dev
    - CONSOLE_PORT={env.CONSOLE_PORT}
    - TDX_INSTALLER_IMAGE_TAG={env.TDX_INSTALLER_IMAGE_TAG}
  annotations:
    description: "\t\t--> Deploy cpu01-base image via Raspberry Pi with RASPBERRY_PI_IP to connected Moducop"
    tags:
      - base
